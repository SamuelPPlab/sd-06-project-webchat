<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO - trybe</title>
    <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }
        body {
          display: flex;
          font: 13px Helvetica, Arial;
          height: 100vh;
          width: 100vw;
        }
        .chatBox {
          width: 90%;
          height: 100%;
          border: solid 2px green;
        }
        .chatBox ul {
          height: 95%;
        }
        form {
          background: #000;
          bottom: 0;
          width: 100%;
          height: 5%;
          border: solid 2px blue;
          display: flex;
        }
        form input {
          padding: 10px;
          width: 90%;
        }
        form button {
          width: 10%;
          background: rgb(130, 224, 255);
          border: none;
          padding: 10px;
          cursor: pointer;
        }
        .sideBar {
          display: flex;
          border: solid 2px blue;
          width: 20%;
          height: 100%;
          background-color: red;
          display: flex;
          flex-direction: column;
        }
        .nicknameBox {
          width: 100%;
          height: 5%;
        }
        .onlineUsersBox {
          background-color: chartreuse;
          width: 100%;
          height: 95%;
        }
        #mensagens {
          list-style-type: none;
          margin: 0;
          padding: 0;
        }
        #mensagens li {
          padding: 5px 10px;
        }
        #mensagens li:nth-child(odd) {
          background: #eee;
        }
    </style>
  </head>
  <body>
    <div class="sideBar">
      <div class="nicknameBox">
        <input data-testid="nickname-box" id="nicknameInput" autocomplete="off" />
        <button data-testid="nickname-button" id="nickname-button">Save</button>
      </div>
      <ul class="onlineUsersBox" id="online-users"></ul>
    </div>
    <div class="chatBox">
      <ul id="mensagens"></ul>
      <form>
        <input data-testid="message-box" id="mensagemInput" autocomplete="off" />
        <button data-testid="send-button" type="submit">Send</button>
      </form>
    <div>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
  <script>
    function generateRandomNickname(length) {
      const string = [];
      var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
      var charactersLength = characters.length;
      for ( var i = 0; i < length; i++ ) {
        string.push(characters.charAt(Math.floor(Math.random() * charactersLength)));
      }
      return string.join('');
    }

    let nickname = generateRandomNickname(16);
    const socket = io();
    socket.username = nickname;
    socket.emit('setNickname', nickname);

     // GET NICKNAME INPUT VALUE AND SEND IT
    const inputNickname = document.querySelector('#nicknameInput');
    const buttonNickname = document.querySelector('#nickname-button');
    buttonNickname.addEventListener('click', (e) =>{
      e.preventDefault();
      const oldNickname = nickname;
      nickname = inputNickname.value;

      socket.emit('nicknameChange', nickname);
      socket.username = nickname;
      inputNickname.value = '';
      return false;
    });

    // GET FORM INPUT VALUE AND SEND IT
    const form = document.querySelector('form')
    const inputMessage = document.querySelector('#mensagemInput')
    form.addEventListener('submit', (e) =>{
      e.preventDefault();

      const messageObj = {
        chatMessage: inputMessage.value,
        nickname,
      };

      socket.emit('message', messageObj);
      inputMessage.value = ''
      return false;
    })

    // CREATE AN MESSAGE ON THE MESSAGE LIST
    const createMessage = (message, type = '') => {
      const messagesUl = document.querySelector('#mensagens');
      const li = document.createElement('li');
      li.innerText = message;
      li.setAttribute('data-testid', type === 'welcome' ? 'online-user2' : 'message');
      messagesUl.appendChild(li);
    }

    // LISTEN EVENT ola AND CREATE A MESSAGE IF EVENT IS ACHIEVED
    socket.on('welcome', (message) => createMessage(message, 'welcome'));

    // LISTEN EVENT mes AND CREATE A MESSAGE IF EVENT IS ACHIEVED
    // IT IS NOT RECEIVED BY THE SENDER
    socket.on('message', (message) => createMessage(message));

    socket.on('recover', (messages) => {
      messages.forEach(message => {
        createMessage(message)
      });
    });
    
    const createOnlineUsers = (users, currentUser) => {
      const usersUl = document.querySelector('#online-users');
      usersUl.innerHTML = '';

      const index = users.indexOf(currentUser);
      const adjustedUsers = (index >= 0)
        ? [currentUser, ...users.slice(0, index), ...users.slice(index + 1)]
        : users;

      adjustedUsers.map((nick) => {
        const li = document.createElement('li');
        li.innerText = nick;
        li.setAttribute('data-testid', 'online-user');
        usersUl.appendChild(li);
      });
    };

    socket.on('onlineUsers', (onlineUsers) =>
      createOnlineUsers(onlineUsers, socket.username));
  </script>
</html> 