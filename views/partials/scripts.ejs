<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io('http://localhost:3000');
  let nickname = '';  
  
  socket.on('connect', () => {
    nickname = Math.random().toString(36).substring(2, 10) + Math.random().toString(36).substring(2, 10);
    document.getElementById('randomNickName').innerHTML = nickname
    socket.emit('newUser', { nickname });
  });
  
  document.getElementById('sendButton').addEventListener('click', () => {
    let chatMessage =  document.getElementById('inputMsg').value;
    let currentNickname = document.getElementById('randomNickName').innerHTML
    socket.emit('message', { chatMessage, nickname:currentNickname });
    chatMessage.value = '';
  })
  
  document.getElementById('changeNick').addEventListener('click', () => {
    let newNick = document.getElementById('nick');
    document.getElementById('randomNickName').innerHTML = newNick.value
    nickname = newNick.value
    socket.emit('handleNickname', nickname)
  })
  socket.on('updateUsers', (allUsers) => {
    const thisUser = allUsers.find((user) => user.id === socket.id);
    const indexUser = allUsers.findIndex((user) => user === thisUser);
    
    allUsers.splice(indexUser, 1);
    allUsers.unshift(thisUser)
    
    const elements = document.getElementsByClassName('online-user');
    while(elements.length > 0){
        elements[0].parentNode.removeChild(elements[0]);
    }
    // const uniqueUsers = allUsers.filter((e, i) => allUsers.indexOf(e) === i);
    // console.log(allUsers)
    // console.log(uniqueUsers)
    allUsers.forEach(user => {
      // if (nickname !== user.nickname) {
        const userList = document.getElementById('user-list');
        const userLi = document.createElement('li');
        userLi.appendChild(document.createTextNode(user.nickname));
        userLi.setAttribute('data-testid', 'online-user');
        userLi.setAttribute('class', 'online-user');
        userList.appendChild(userLi);
      // }
    });
  });

  socket.on('message', (result) => {
    const list = document.getElementById('list');
    const listItem = document.createElement('li');
    listItem.appendChild(document.createTextNode(result));
    listItem.setAttribute('data-testid', 'message');
    list.appendChild(listItem);
  });


</script>