<!DOCTYPE html>
<html>
	<head>
		<title>Projeto WebChat</title>
		<style>
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}
			body {
				font: 13px Helvetica, Arial;
			}

			#mensagens {
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			#mensagens li {
				padding: 5px 10px;
			}
			#mensagens li:nth-child(odd) {
				background: #eee;
			}

			.div-chat {
				display: flex;
				height: 100vh;
				justify-content: center;
				margin: 0px auto;
				max-width: 100vw;
				width: 100%;
			}

			.users {
				background-color: rgb(230, 230, 230);
				width: 30%;
			}

			.messages {
				background-color: rgb(247, 247, 247);
				width: 70%;
			}

			.send-message {
				background: rgba(0, 0, 0, 0.2);
				bottom: 0;
				padding: 20px;
				position: fixed;
				width: 100%;
			}

			.send-message input {
				border: 0;
				margin-right: 0.5%;
				padding: 10px;
				width: 90%;
			}

			.send-message button {
				background: rgb(130, 224, 255);
				border: none;
				cursor: pointer;
				padding: 10px;
				width: 9%;
			}

			.choose-nickname {
				margin: 20px;
			}

			.choose-nickname input {
				padding: 5px;
				width: 70%;
			}

			#send-new-nickname {
				padding: 5px;
				width: 20%;
			}

			.users-online {
				margin: 50px 20px;
			}
		</style>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
	</head>
	<body>
		<div class="div-chat">
			<section class="users">
				<div class="choose-nickname">
					<h1 id="your-user"></h1>
					<input id="change-nickname" data-testid="nickname-box" type="text" />
					<button id="send-new-nickname" data-testid="nickname-button">
						Enviar
					</button>
				</div>
				<div class="users-online">
					<h1>Usu√°rios online:</h1>
					<ul id="users"></ul>
				</div>
			</section>

			<section class="messages">
				<ul id="messages-list">
					<% allmessages.forEach((item) => { %>
					<li data-testid="message">
						<%= `${item.timestamp} ${item.nickname} ${item.message}` %>
					</li>
					<% }) %>
				</ul>
			</section>
		</div>

		<section class="send-message">
			<input
				data-testid="message-box"
				id="input-message"
				type="text"
				placeholder="Digite sua mensagem aqui"
			/>
			<button data-testid="send-button" id="btn-send-message">Enviar</button>
		</section>
		<script>
			const socket = io();
			let nickname;

			const h1User = document.querySelector('#your-user');
			const newNickname = document.querySelector('#change-nickname');
			const sendNewNickname = document.querySelector('#send-new-nickname');

			const usersList = document.querySelector('#users');
			const messagesList = document.querySelector('#messages-list');

			const inputMessage = document.querySelector('#input-message');
			const sendBtn = document.querySelector('#btn-send-message');

			sendNewNickname.addEventListener('click', () => {
				nickname = newNickname.value;
				h1User.innerText = nickname;
				newNickname.value = '';
				socket.emit('newNickname', nickname);
			});

			sendBtn.addEventListener('click', () => {
				const message = inputMessage.value;
				inputMessage.value = '';
				socket.emit('message', { chatMessage: message, nickname });
			});

			socket.on('connect', () => {
				nickname = socket.id.slice(0, 16);
				socket.emit('newUser', nickname);
				h1User.innerText = nickname;
			});

			socket.on('message', (message) => {
				const messageLi = document.createElement('li');
				messageLi.innerHTML = message;
				messageLi.setAttribute('data-testid', 'message');
				messagesList.appendChild(messageLi);
			});

			socket.on('updateUsers', (users) => {
				const findUser = users.find((user) => user.id === socket.id);
				const index = users.findIndex((user) => user === findUser);
				users.splice(index, 1);
				users.unshift(findUser);
				usersList.innerText = '';
				users.forEach((item) => {
					const nicknameList = document.createElement('li');
					nicknameList.innerText = item.nickname;
					nicknameList.setAttribute('data-testid', 'online-user');
					usersList.appendChild(nicknameList);
				});
			});
		</script>
	</body>
</html>
