<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io('http://localhost:3000');

  const userNickname = document.querySelector('#user-nickname');
  const messageForm = document.querySelector('#messageForm');
  const nicknameInput = document.querySelector('#nicknameForm');
  const inputMessage = document.querySelector('#messageInput');
  const inputNickname = document.querySelector('#nicknameInput');

  let currentUser;

  socket.on('connect', () => {
    const nickname = createRandomNick(16);
    mainUser = { nickname };
    socket.emit('userLogin', nickname);
  });

  socket.on('usersConnected', (users) => {
    currentUser = usersConnected.find(user => user.nickname === mainUser.nickname);
    listUsers(usersConnected);
  })

  socket.on('message', (message) => createMessage(message));

  const createRandomNick = (length) => {
    const randomChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i += 1) {
      result += randomChars.charAt(Math.floor(Math.random() * randomChars.length));
    }
    return result;
  };

  nicknameForm.addEventListener('submit', (e) => {
    e.preventDefault();
    currentUser.nickname = inputNickname.value;
    socket.emit('updatedUser', currentUser);
  })
  
  messageForm.addEventListener('submit', (e) =>{
    e.preventDefault();
    const { nickname } = currentUser;
    socket.emit('message', { nickname, chatMessage: inputMessage.value });
    inputMessage.value = '';
    return false;
  });
  
  const createMessage = (message) => {
    const messagesUl = document.querySelector('#messages');
    const li = document.createElement('li');
    li.innerText = message;
    li.setAttribute('data-testid', 'message');
    messagesUl.appendChild(li);
  }
  
  const createUserLiElement = (user) => {
    const usersUl = document.querySelector('#users');
    const li = document.createElement('li');
    li.innerText = user.nickname;
    li.setAttribute('data-testid', 'online-user');
    usersUl.appendChild(li);
  }

  const listUsers = (users) => {
    const usersUl = document.querySelector('#users');
    usersUl.innerHTML = '';
    createUserLiElement(mainUser);
    users.filter(user => user.id !== mainUser.id).forEach(user => createUserLiElement(user));
  }
</script>