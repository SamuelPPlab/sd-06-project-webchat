<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
  </head>
  <body>
    <header><h1>Webchat</h1></header>
    <main>
      <div class="container">
        <div class="content">
          <div class="list-people">
            <input id="input-nickname" data-testid="nickname-box"/>
            <button id="btn-nickname" data-testid="nickname-button">OK</button>
            <ul id="ul-users"></ul>
          </div>
          <div class="right-side">
            <div class="list-messages">
              <ul id="messages" class="ul-messages"></ul>
            </div>
            <div class="send-message">
              <input
                id="input-message"
                
                placeholder="Digite sua mensagem!"
                data-testid="message-box"
              />
              <!-- </textarea> -->
              <button id="send-button" data-testid="send-button">Send</button>
            </div>
          </div>
        </div>

      </div>
    </main>
    <script>
        const socket = io();
        window.onload = handleNickName;

        const send = document.getElementById('send-button');
        const inputMessage = document.getElementById('input-message');
        const inputNickname = document.getElementById('input-nickname');
        const saveNickName = document.getElementById('btn-nickname')

        function generateNickName() {
          const absurdo = 'abcdefghijklmnopqrstuvwxyz0123456789'
          const user = []
          for (i = 1; i < 17; i++) {
            let numberRandom = Math.floor(Math.random() * 36)
            console.log(numberRandom)
            user.push(absurdo[numberRandom])
          }
          sessionStorage.setItem('user', user.join(''))
          rendernickName(user.join(''))
          console.log(user.join(''))
        }

        function rendernickName(nickName) {
          const usersUl = document.getElementById('ul-users')
          const userLi = document.createElement('li');
          userLi.innerText = nickName
          userLi.setAttribute('data-testid','online-user')
          usersUl.appendChild(userLi)
          // usersUl.removeChild(usersUl.childNodes[0])
          // usersUl.appendChild(userLi)
        }

        function handleNickName() {
          const userInStorage = sessionStorage.getItem('user')
          if (!userInStorage) {
            generateNickName()
          }
          rendernickName(userInStorage)

          return false
        }
   
        saveNickName.addEventListener('click', () => {
          if (inputNickname.value) {
            sessionStorage.setItem('user', inputNickname.value)
            console.log(inputNickname.value)
            rendernickName(inputNickname.value)
          }
        })

        send.addEventListener('click', () => {
             if (inputMessage) {
              socket.emit('message', { chatMessage: inputMessage.value, nickname: inputNickname.value });
              inputMessage.value = '';
            }
        })
        
        const createMessage = (message) => {
            const messageUl = document.getElementById('messages');
            const li = document.createElement('li');
            li.innerText = message
            li.setAttribute("data-testid","message")
            messageUl.appendChild(li);
        }

        socket.on('message', (message) => createMessage(message))

      </script>
  </body>
</html>