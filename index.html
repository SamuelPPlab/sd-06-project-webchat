<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO - trybe</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <ul id="mensagens"></ul>
    <form action="" id="messageForm">
      <input data-testid="message-box" id="mensagemInput" autocomplete="off" />
      <button data-testid="send-button">Send</button>
    </form>
    
    <h2>Users</h2>
    
    <ul id="users"></ul>
    <form action="" id="usersForm">
      <input data-testid="nickname-box" id="usersInput" autocomplete="off" />
      <button data-testid="nickname-button">Save</button>
    </form>

    <script>
      const socket = io();
      const messageForm = document.querySelector('#messageForm');
      const usersForm = document.querySelector('#usersForm');
      const inputMessage = document.querySelector('#mensagemInput');
      const usersInput = document.querySelector('#usersInput');

      let currUser;

      usersForm.addEventListener('submit', (e) =>{
        e.preventDefault();
        currUser = usersInput.value;
        socket.emit('users', usersInput.value);
        usersInput.value = ''
        return false;
      });

      messageForm.addEventListener('submit', (e) =>{
        e.preventDefault();
        const chatMessage = inputMessage.value
        const nickname = currUser;
        socket.emit('message', { chatMessage, nickname });
        inputMessage.value = ''
        return false;
      });
      

      const createMessage = (message) => {
        const messagesUl = document.querySelector('#mensagens');
        const li = document.createElement('li');
        li.innerText = message;
        li.setAttribute('data-testid', 'message');
        messagesUl.appendChild(li);
      }

      const randomName = () => {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let name = '';
        for (let i = 0; i < 16; i += 1) {
          name += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return name;
      };

      const createUsers = (user) => {
        const usersUl = document.querySelector('#users');
        const li = document.createElement('li');
        if (typeof user === 'string') {
          li.innerText = user;
          li.setAttribute('data-testid', 'online-user');
          usersUl.appendChild(li);
          return;
        }
        user.map((u) => {
          if (u.nickname !== currUser) {
            li.innerText = u.nickname;
            li.setAttribute('data-testid', 'online-user');
            usersUl.appendChild(li);
          }
        })
      }

      socket.on('connect', () => {
        const nickname = randomName();
        currUser = nickname;
        socket.emit('userLogin', nickname);
      });


      socket.on('message', (message) => {createMessage(message)});
      socket.on('users', (user) => {console.log(user); createUsers(user)})

    </script>
  </body>
</html>