<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title>Projeto WebChat</title>
  <style>
    #input-nickName {
      float: left;
      width: 45%
    }
    #div-nickName {
      border: 1px solid black;
      width: 45%;
      float: left;
      margin: 5px;
    }
    #div-mensagens {
      border: 1px solid black;
      float: right;
      width: 50%
    }
    #input-mensagens {
      float: right;
      text-align: center;
      width: 100%
    }
    #input-mensagens input {
      clear: both;
      margin: 5px;
      width: 80%;
    }
    #input-mensagens button {
      position: absolute;
      margin: 5px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
</head>
<body>
  <h1>Iniciando WebChat</h1>
  <div id="input-nickName">
    <input id="nickNameInput" autoComplete="off" placeholder="Insira seu NickName" data-testid="nickname-box"/>
    <button id="nickNameButton" testid="nickname-button">Salvar NickName</button>
  </div>

  <div id="div-mensagens">
    <h3>Mensagens:</h3>
    <ul id="ul-mensagens"></ul>
  </div>

  <div id="div-nickName" >
    <h3>Nicknames:</h3>
    <ul id="ul-nickName">
    </ul >
  </div>

  <div id="input-mensagens">
    <input id="mensageInput" autoComplete="off" placeholder="Digite uma nova mensagem" data-testid="message-box"/>
    <button id="mensageButton" data-testid="send-button">Send</button>
  </div>

  <script>
    const socket = io();
    const inputMessage = document.querySelector('#mensageInput');
    const inputNickName = document.querySelector('#nickNameInput');
    const buttonMensage = document.querySelector('#mensageButton');
    const buttonNickName = document.querySelector('#nickNameButton');

    // const generatorNickName = (length) => {
    //   let result = '';
    //   const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    //   const charactersLength = characters.length;
    //   for (let index = 0; index < length; index += 1) {
    //     result += characters.charAt(Math.floor(Math.random() * charactersLength));
    //   }
    //   return result;
    // };

    let user = '';
    let userId = '';

    const createMessage = (msg) => {
      const ulListMessages = document.querySelector('#ul-mensagens');
      const newAppend = document.createElement('li');
      newAppend.setAttribute('data-testid', 'message');
      newAppend.innerText = msg;
      ulListMessages.appendChild(newAppend);
    }
    
    createOnlineNickNames = (arr) => {
      arr.map(({ tagId, randomNickName }) => console.log(tagId, randomNickName));
    }

    const createNickName = (conex) => {
      const { tagId, randomNickName } = conex;
      // createOnlineNickNames(onChat);
      // console.log('front', onChat);
      const ulListNickName = document.querySelector('#ul-nickName');
      const newLiNickName = document.createElement('li');
      newLiNickName.innerText = randomNickName;
      newLiNickName.setAttribute('data-testid', 'online-user');
      newLiNickName.setAttribute('id', `${tagId}`);
      ulListNickName.appendChild(newLiNickName);
      userId = tagId;
      user = randomNickName
    }

    const alterNickName = (newUser) => {
      const currentNickName = document.querySelector(`#${userId}`);
      currentNickName.innerText = newUser;
    }

    buttonMensage.addEventListener('click', () => {
      const info = { chatMessage: inputMessage.value, nickname: user }
      socket.emit('message', info);
      inputMessage.value = '';
    })

    buttonNickName.addEventListener('click', () => {
      socket.emit('nickName', inputNickName.value);
      // const newUser = inputNickName.value;
      const newUser = { nickname: inputNickName.value, id: userId };
      alterNickName(newUser);
      socket.emit('alterNickName', newUser);
      inputNickName.value = '';
    })

    socket.on('message', (msg) => createMessage(msg));
    socket.on('nickName', (user) => createNickName(user));
    socket.on('conex', (conex) => createNickName(conex));
    socket.on('alterNickName', (newUser) => alterNickName(newUser));
  </script>
</body>
</html>