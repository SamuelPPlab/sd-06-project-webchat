<!DOCTYPE html>
<html>

<head>
  <title>WebChat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font: 13px Helvetica, Arial;
    }

    form {
      background: #000;
      padding: 3px;
      position: fixed;
      bottom: 0;
      width: 100%;
    }

    form input {
      border: 0;
      padding: 10px;
      width: 90%;
      margin-right: 0.5%;
    }

    form button {
      width: 9%;
      background: rgb(130, 224, 255);
      border: none;
      padding: 10px;
      cursor: pointer;
    }

    #mensagens {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    #mensagens li {
      padding: 5px 10px;
    }

    #mensagens li:nth-child(odd) {
      background: #eee;
    }
  </style>
  <title>WebChat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
</head>

<body>

  <input type="text" id="nickname-box" data-testid="nickname-box" placeholder="Digite seu apelido...">
  <button id='nickname-button' data-testid="nickname-button">Salvar</button>

  <input type="text" id="message-box" data-testid="message-box" placeholder="Digite sua mensagem...">
  <button id="send-button" data-testid="send-button">Enviar</button>

  <h2>Usu√°rios</h2>
  <div>
    <ul id="users">
    </ul>
  </div>
  <div>
    <h2>Mensagens</h2>
    <ul id="message">
      <% messages.forEach((msg)=> { %>
        <li data-testid="message">
          <%= msg.date %> - <%= msg.nickname %>: <%= msg.chatMessage%>
        </li>
        <% }) %>
    </ul>
  </div>
</body>

<script>
  const socket = io('http://localhost:3000');

  const nicknameButton = document.querySelector('#nickname-button');
  const messageButton = document.querySelector('#send-button');
  const messageBox = document.querySelector('#message-box')
  const nicknameBox = document.querySelector('#nickname-box');
  const userMessage = document.querySelector('#message');
  const userList = document.querySelector('#users');

  let nick;
  let userId;

  const randomNickName = () => {
    const length = 16;
    const characteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';

    for (let i = 0; i < length; i += 1) {
      result += characteres.charAt(Math.floor(Math.random() * characteres.length));
    }
    return result;
  };

  const renderMessageSocketTrigger = () => {
    socket.emit('message', { nickname: nick, chatMessage: messageBox.value, userId: socket.id });
    messageBox.value = '';
    return false;
  }

  socket.on('connect', () => {
    nick = randomNickName()
    socket.emit('connected', { nickname: nick });
  });

  socket.on('connected', (item) => {
    console.log(item)
    item.forEach((user => {
      const li = document.createElement("li");
      li.setAttribute('data-testid', 'online-user')
      li.setAttribute('id', user.socketId)
      li.innerHTML = user.nickname;
      userList.appendChild(li);
    }));
  });

  socket.on('message', (item) => {
    const li = document.createElement("li");
    li.setAttribute('data-testid', 'message')
    li.innerHTML = item;
    userMessage.appendChild(li);
  });

  nicknameButton.addEventListener('click', () => {
    nick = nicknameBox.value;
    socket.emit('nickChange', { nickname: nick, id: socket.id });
  });

  socket.on('nickChange', (nickname, id) => {
    const user = document.getElementById(id);
    user.innerHTML = nickname;
  })

  socket.on('user-off', ({ id }) => {
    console.log('teste')
    const user = document.getElementById(id);
    user.remove();
  });

  messageButton.addEventListener('click', renderMessageSocketTrigger);
</script>

</html>